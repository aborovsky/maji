#!/bin/bash
source "$(dirname ${BASH_SOURCE[0]})/_functions"
PROJECT=$(basename $(pwd))
echo "Setting up $PROJECT"

if brew_available ; then
  brew_dep_installed 'node' || brew install node
  brew_dep_installed 'ant' || brew install ant

  if ! command_available 'phantomjs' ; then
    # This can be removed when Homebrew supplies a working PhantomJS build for El Capitan again
    if [[ "$OSTYPE" == "darwin15"* ]]; then
      # If there is no phantomjs available and we're on El Capitan, we cannot install
      # it automatically.
      echo 'No PhantomJS detected and unable to install it through Homebrew on OS X El Capitan. You can download and install a working build from the PhantomJS website: http://phantomjs.org/download.html'
      exit 1
    else
      brew install phantomjs
    fi
  fi

  # npm is included with node in newer version, so this normally shouldn't be needed.
  command_available 'npm' || brew install npm
else
  warning 'Warning: Homebrew not detected. Not installing some dependencies.'
fi

if [[ "$OSTYPE" == "darwin"* ]]; then
  npm_package_available 'ios-deploy@1.3.2' || npm install 'ios-deploy@1.3.2'
  npm_package_available 'ios-sim@3.1.1' || npm install 'ios-sim@3.1.1'
fi

npm install

# Temporary fix because falafel has a dependency on acorn 0.11.0, this can be removed when those packages are upgraded
# my-app@1.0.0
# └─┬    aliasify@1.8.0
#     └─┬ browserify-transform-tools@1.3.3
#         └─┬ falafel@1.0.1
#             └── acorn@0.11.0
npm upgrade acorn

bundle install

if [ -d .git ]; then
  echo 'Setting up git hooks...'
  for h in hooks/*; do ln -sf ../../$h .git/hooks/$(basename $h); done
fi

echo -n 'Setup finished. '
