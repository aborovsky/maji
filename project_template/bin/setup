#!/bin/bash
source "$(dirname ${BASH_SOURCE[0]})/_functions"
PROJECT=$(basename $(pwd))
echo "Setting up $PROJECT"

if brew_available ; then
  brew_dep_installed 'node' || brew install node
  brew_dep_installed 'ant' || brew install ant

  if ! command_available 'phantomjs' ; then
    brew install phantomjs
  fi

  # npm is included with node in newer version, so this normally shouldn't be needed.
  command_available 'npm' || brew install npm
else
  warning 'Warning: Homebrew not detected. Not installing some dependencies.'
fi

if [[ "$OSTYPE" == "darwin"* ]]; then
  npm_package_available 'ios-deploy@1.8.5' || npm install 'ios-deploy@1.8.5'
  npm_package_available 'ios-sim@5.0.6' || npm install 'ios-sim@5.0.6'
fi

npm install

# Temporary fix because falafel has a dependency on acorn 0.11.0, this can be removed when those packages are upgraded
# my-app@1.0.0
# └─┬    aliasify@1.8.0
#     └─┬ browserify-transform-tools@1.3.3
#         └─┬ falafel@1.0.1
#             └── acorn@0.11.0
npm upgrade acorn

bundle install

if [ -d .git ]; then
  echo 'Setting up git hooks...'
  for h in hooks/*; do ln -sf ../../$h .git/hooks/$(basename $h); done
fi

echo -n 'Setup finished. '
